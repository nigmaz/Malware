# Malware Technique

- Mục lục

  - [Giới thiệu phân tích file văn bản Office và PDF](#giới-thiệu-phân-tích-file-văn-bản-office-và-pdf)

  - [ANTIVIRUS EVASION TECHNIQUES](#antivirus-evasion-techniques)

  - [Persistence](#persistence)

  - [Machine Learning with MALWARE](#machine-learning-with-malware)

  - [References](#references)

## Giới thiệu phân tích file văn bản Office và PDF.

- Trong quá trình tìm hiểu exploit, một kỹ năng quan trọng là phân tích được các dạng file khác nhau. Nội dung bài viết sẽ trình bày các gợi ý cũng như công cụ để phân tích file văn bản (Office và PDF) – dạng file chủ yếu dùng để khai thác thực thi mã độc.

- **Phương pháp tiếp cận phân tích**:

  - Xác định được vị trí của shellcode, VB marco hay đoạn javascript có thể có nguy cơ trong văn bản.
  - Trích xuất lọc ra được đoạn mã độc hại ra khỏi file.
  - Nếu có thể (giải mã đơn giản) thì disassembly/debug đoạn shellcode.
  - DeObfuscate (nếu có thể) đoạn mã Javascript, ActionScript hay VB marco.
  - Đọc và phân tích, tìm hiểu cơ chế lây nhiễm của đoạn code.

- **Thành phần của Office file**:

  - Tìm hiểu cấu trúc OLE file -> phân tích được hệ thống các trường trong file Office.
  - Dữ liệu thành phần trong OLE file bao gồm 2 dạng quan trọng cần chú ý gồm `"storage"` – thư mục và `"stream"` – file.
  - Excel file có thành phần chứa dữ liệu nằm trong trường `"workbook"`.
  - PPT file chứa dữ liệu trong trường `"PowerPoint Document"`.
  - Word file chứa dữ liệu trong trường bổ sung.

- **Công cụ phân tích Office file**:

  - `OfficeMalScanner` phân tích tìm kiếm shellcode và VB marco trong file word và excel.
    - MalHost-Setup trích xuất lọc ra shellcode nằm trong Office file và lưu ra file exe để phân tích tiếp (là một module độc lập nằm trong tool OfficeMalScanner)
  - `Offvis` cho phép đọc nội dung và cấu trúc header trong file Office và các thành phần có khả năng khai thác (công cụ được công cụ từ microsoft)
  - `Office Binary Translator` chuyển đổi Office file sang dạng Open XML file (tích hợp công cụ `Biffview` để so sánh)
  - pyOLEScanner.py công cụ python giúp decode nội dụng Binary của file Office. Giải mã một phần nội dung.
  - Các công cụ hex view, hex editor với các module phân tích cấu trúc header file Office v.v.

- **Phân tích file Office \_ các lệnh cơ bản**:

  - OfficeMalScanner file.doc scan.
  - `"Scan"` để phát hiện shellcode dựa trên shellstruct GetPC.
  - `"Info"` các thông tin trong cấu trúc OLE file cũng như các đoạn VB-marco nếu có.
  - MalHost-Setup để trích xuất shellcode ra file thực thi.

- **Thành phần của PDF file**:

  - Cấu trúc một file PDF bao gồm header, đối tượng, các bảng tham chiếu chéo(xác định các đối tượng liên kết) và các phần bổ sung.
  - `"/OpenAction"` hoặc `"/AA"` (Additional Action) gồm các script hoặc các action tự động thực thi.
  - `"/Name"`, `"AcroForm"`,"`/Action"` chứa thông tin và các tác vụ thực thi.
  - `"/JavaScript"` thực thi js.
  - `"/GoTo"` view file PDF nguồn và các file PDF tiếp theo.
  - `"/Launch"` gọi một chương trình hay mở một nội dung ngoài file PDF.
  - `"/URI"` tác vụ trợ giúp truy cập các đường link.
  - Chú ý tới các mã obfuscation với mã hex (ví dụ `"JavaScript"` -> "J#61vaScript).

- **Công cụ phân tích Adobe PDF file**:

  - `PDFiD` xác định các chuỗi string trong file PDF cũng như các đoạn scripts và action có thể đọc được.
  - `PDF-Parser` đọc cấu trúc file PDF.
  - `Origami's` pdfextract và `Jsunpack-n's` pdf.py giải nén các đoạn JavaScript.
  - `PDF Stream Dumper` gồm các công cụ phân tích PDF với giao diện trực quan.
  - `PDF X-Ray Lite` tạo file HTML kết quả chứa nội dung của cấu trúc PDF file cũng như giải mã.
  - `SWF mastah` trích xuất nội dung SWF trong file PDF.
  - `Malzilla` và `SpiderMonkey` giúp deobfuscate mã nhúng JavaScript trong file PDF.
  - `Wepawet, VirusTotal` hoặc `sanbox tools` cho phép tạo môi trường ảo để phân tích hành vi của file PDF.
  - `ExeFilter` lọc mã scripts trong file Office hay PDF.

## ANTIVIRUS EVASION TECHNIQUES

- ON-DISK: Modifying malicious files physically stored on the disk on victim machine, to evade AV detection.

  - Obfuscators
  - Packers
  - Protectors (Software)
  - Cryptors

- IN-MEMORY: The in-memory based detection evasion techniques do not include writing any changes to disk. They directly work on memory level. Thus more common now a days

  - Process Memory Injection
  - Inline function hooking
  - Process Hollowing
  - DLL Injection

- EDR (Endpoint Detection and Response): là giải pháp bảo mật giúp theo dõi các hoạt động bất thường trên thiết bị đầu cuối và đưa ra phản ứng kịp thời. Qua kinh nghiệm thực tiễn và quan sát nhiều case study được chia sẻ từ các tổ chức uy tín trong ngành thì CyberJutsu xin chia sẻ ngắn gọn:

  - 0.  EDR không được cài đặt toàn toàn trên toàn bộ server và endpoint. Các hệ thống legacy hoặc công nghệ vận hành (OT) thường bị bỏ sót.
  - 1.  EDR bị cấu hình sai rules, chẳng hạn như có quá nhiều ngoại lệ trong whitelist, không ở chế độ chặn chủ động hoặc admin tắt các tính năng quan trọng.
  - 2.  Các cảnh báo của EDR không được giám sát và xử lý kịp thời bởi đội ngũ vận hành bảo mật. EDR phát hiện hoạt động đáng ngờ nhưng không ai kịp hành động.
  - 3.  Kẻ tấn công chiếm được quyền truy cập cấp cao (vd: thông tin đăng nhập domain admin), từ đó có thể vô hiệu hóa hoặc vượt qua các biện pháp bảo vệ của EDR.
  - 4.  EDR bỏ sót vì kẻ tấn công sử dụng các kỹ thuật lách trốn (Defense Evasion) tiên tiến. Tuy ít phổ biến hơn những lý do khác, nhưng các nhóm tội phạm hàng đầu vẫn đầu tư tìm cách vượt qua các sản phẩm EDR phổ biến.
  - 5.  Việc triển khai ransomware chỉ là giai đoạn cuối của một chuỗi tấn công dài hơn. Các giai đoạn trước của Red Team như: Initial Access, Crendetial Access Attack và Lateral Movement lại thường xảy ra trên các hệ thống không có EDR.

> "EDR" Chúng ta đừng quá phụ thuộc vào EDR mà hãy xây dựng chiến lược bảo mật chuyên sâu, kết hợp rèn luyện ý thức bảo mật cho nhân viên và giám sát liên tục. Các chuyên gia bảo mật cũng cần không ngừng cập nhật kiến thức để đối phó với các chiêu thức tấn công mới. TOP 6 LÍ DO VÌ SAO EDR KHÔNG PHÁT HIỆN ĐƯỢC RANSOMWARE!

## Persistence

- 1. **Autostart Entry Points**:

  - **Registry Keys**: Mã độc có thể tạo hoặc chỉnh sửa các khóa registry để tự động khởi động khi hệ thống Windows khởi động. Ví dụ, mã độc có thể thêm một mục vào các khóa như `HKLM\Software\Microsoft\Windows\CurrentVersion\Run` hoặc `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`.

  - **Startup Folder**: Mã độc có thể sao chép chính nó vào thư mục Startup của Windows (`C:\Users\[Username]\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`), để nó được khởi động cùng với hệ điều hành.

- 2. **Scheduled Tasks**: Mã độc có thể tạo các tác vụ theo lịch trình (scheduled tasks) trong Windows Task Scheduler để tự động khởi động vào một thời điểm xác định hoặc khi một sự kiện cụ thể xảy ra (ví dụ, khi người dùng đăng nhập).

- 3. **Services**: Mã độc có thể đăng ký chính nó như một dịch vụ của hệ điều hành, đảm bảo rằng nó sẽ được khởi động cùng với các dịch vụ hệ thống khác khi hệ thống khởi động.

- 4. **WMI (Windows Management Instrumentation)**: Mã độc có thể sử dụng các sự kiện WMI để tạo ra các bộ lọc sự kiện tự động kích hoạt mã độc khi một sự kiện cụ thể xảy ra trên hệ thống.

- 5. **Browser Extensions**: Một số mã độc có thể cài đặt các tiện ích mở rộng trên trình duyệt để đảm bảo rằng chúng sẽ tiếp tục hoạt động mỗi khi trình duyệt được mở.

- 6. **Bootkits và Rootkits**: Bootkits và rootkits là các loại mã độc tiên tiến có thể can thiệp vào quá trình khởi động của hệ điều hành hoặc thậm chí là phần cứng để đảm bảo rằng chúng sẽ khởi động trước hoặc cùng với hệ điều hành.

- 7. **DLL Injection**: Mã độc có thể sử dụng kỹ thuật DLL Injection để tiêm mã độc vào các quá trình hợp pháp đang chạy trên hệ thống. Điều này giúp mã độc ẩn mình và khó bị phát hiện hơn.

- 8. **Modifying System Files**: Mã độc có thể thay đổi hoặc thay thế các tập tin hệ thống quan trọng để đảm bảo rằng nó sẽ được thực thi khi hệ thống hoặc một ứng dụng hợp pháp nào đó khởi động.

- 9. **Firmware and BIOS**: Các mã độc tinh vi có thể lây nhiễm vào firmware hoặc BIOS của máy tính, đảm bảo rằng chúng sẽ tồn tại và hoạt động ngay cả khi hệ điều hành được cài đặt lại.

> `"Persistence"` trong bối cảnh mã độc (malware) là một kỹ thuật mà mã độc sử dụng để đảm bảo rằng nó sẽ vẫn tồn tại và tiếp tục hoạt động ngay cả sau khi hệ thống khởi động lại hoặc sau khi người dùng cố gắng loại bỏ nó. Các kỹ thuật này giúp mã độc duy trì sự hiện diện của nó trên hệ thống và khó bị phát hiện cũng như loại bỏ hơn. Dưới đây là một số phương pháp phổ biến mà mã độc có thể sử dụng để đạt được sự "persistence":

## Machine Learning with MALWARE

- https://whitehat.vn/threads/tan-man-ve-machine-learning-trong-malware-analysis.17021/
- https://github.com/ocatak/malware_api_class

## References:

- https://whitehat.vn/threads/phan-tich-ma-doc-windows-co-ban-phan-i.16951/
- https://whitehat.vn/threads/tong-hop-cac-bai-viet-hay-ve-virus-malware.9674
